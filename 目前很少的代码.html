<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Vesper Obsidian Nexus</title>
    <style id="app-style">
        /* ======= 配置区（置顶） ======= */
        :root {
            --bg-body: #0a0a0a;
            --bg-panel: #0f0f10;
            --bg-elevated: #141416;
            --bg-hover: #1d1d20;
            --border: #1f1f22;
            --text-main: #f5f5f7;
            --text-sub: #8b8b90;
            --accent: #e5e5e7;
            --muted: #2a2a2f;
            --radius: 10px;
            --card-radius: 12px;
            --font-stack: "SF Pro Display", "SF Pro Text", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            --icon-size: 48px;
            --grid-gap: 18px;
            --shadow-soft: 0 20px 80px rgba(0,0,0,0.35);
            --shadow-strong: 0 14px 60px rgba(0,0,0,0.45);
        }

        [data-theme="dusk"] {
            --bg-body: #f5f5f7;
            --bg-panel: #ffffff;
            --bg-elevated: #f8f8fa;
            --bg-hover: #ededf2;
            --border: #e5e5eb;
            --text-main: #1d1d1f;
            --text-sub: #5e5e67;
            --accent: #0d0d11;
            --muted: #dcdce5;
        }

        [data-theme="graphite"] {
            --bg-body: #060608;
            --bg-panel: #0c0c0e;
            --bg-elevated: #0f0f12;
            --bg-hover: #16161b;
            --border: #1a1a1f;
            --text-main: #ececed;
            --text-sub: #7b7b83;
            --accent: #d6d6d9;
            --muted: #2b2b30;
        }

        [data-theme="quartz"] {
            --bg-body: #111;
            --bg-panel: #151515;
            --bg-elevated: #191919;
            --bg-hover: #1f1f1f;
            --border: #252525;
            --text-main: #efefef;
            --text-sub: #9a9aa0;
            --accent: #dcdcdf;
            --muted: #2f2f32;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body {
            margin: 0; height: 100vh; display: grid; grid-template-columns: 280px 1fr;
            background: radial-gradient(circle at 20% 20%, rgba(255,255,255,0.02), transparent 40%), var(--bg-body);
            color: var(--text-main); font-family: var(--font-stack); overflow: hidden;
        }

        h1,h2,h3,h4,h5,p { margin: 0; }
        .accent { letter-spacing: 0.3px; }

        /* ======= 侧栏 ======= */
        .sidebar {
            background: linear-gradient(180deg, rgba(255,255,255,0.04), transparent 40%), var(--bg-panel);
            border-right: 1px solid var(--border);
            display: flex; flex-direction: column; padding: 22px; gap: 16px; box-shadow: var(--shadow-soft);
        }

        .brand { display: flex; flex-direction: column; gap: 6px; }
        .brand-title { font-weight: 700; font-size: 18px; letter-spacing: -0.2px; }
        .brand-sub { color: var(--text-sub); font-size: 12px; }

        .nav-group { display: grid; gap: 10px; }
        .nav-item { padding: 10px 12px; background: var(--bg-elevated); border: 1px solid var(--border); border-radius: var(--radius);
            color: var(--text-sub); cursor: pointer; display: flex; align-items: center; justify-content: space-between; transition: 0.2s; }
        .nav-item:hover { background: var(--bg-hover); color: var(--text-main); }
        .nav-item.active { border-color: var(--accent); color: var(--text-main); box-shadow: var(--shadow-soft); }

        .nav-label { display: flex; align-items: center; gap: 8px; }
        .pill { padding: 3px 8px; border-radius: 999px; background: var(--muted); color: var(--text-main); font-size: 11px; }

        .sidebar-footer { margin-top: auto; display: grid; gap: 10px; }
        .btn { border: 1px solid var(--border); background: var(--bg-elevated); color: var(--text-main); border-radius: var(--radius);
            padding: 10px 12px; font-size: 12px; letter-spacing: 0.2px; cursor: pointer; transition: 0.2s; text-align: left; }
        .btn:hover { background: var(--bg-hover); }
        .btn-ghost { background: transparent; }

        /* ======= 主区域 ======= */
        .main { position: relative; overflow: hidden; display: flex; flex-direction: column; }
        .topbar { display: flex; align-items: center; gap: 12px; padding: 18px 22px; border-bottom: 1px solid var(--border); }
        .top-title { font-weight: 600; font-size: 16px; }
        .search { flex: 1; background: var(--bg-elevated); border: 1px solid var(--border); border-radius: var(--radius); padding: 10px 12px; color: var(--text-main); }
        .chips { display: flex; gap: 8px; align-items: center; }
        .chip { padding: 8px 12px; border-radius: 10px; background: var(--bg-elevated); border: 1px solid var(--border); cursor: pointer; color: var(--text-sub); font-size: 12px; }
        .chip.active { color: var(--text-main); border-color: var(--accent); }

        .content { flex: 1; overflow-y: auto; padding: 22px; display: grid; grid-template-columns: 2fr 1fr; gap: 16px; }
        .panel { background: var(--bg-panel); border: 1px solid var(--border); border-radius: var(--card-radius); padding: 16px; box-shadow: var(--shadow-soft); display: flex; flex-direction: column; gap: 12px; }
        .panel-header { display: flex; justify-content: space-between; align-items: center; }
        .panel-title { font-weight: 600; letter-spacing: 0.1px; }
        .muted { color: var(--text-sub); font-size: 12px; }

        /* ======= 网格 ======= */
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: var(--grid-gap); }
        .card { background: var(--bg-elevated); border: 1px solid var(--border); border-radius: var(--card-radius); padding: 14px; display: flex; flex-direction: column; align-items: center; gap: 12px; cursor: pointer; transition: 0.2s; position: relative; }
        .card:hover { border-color: var(--accent); background: var(--bg-hover); }
        .card.dragging { opacity: 0.5; border-style: dashed; }
        .card img { width: var(--icon-size); height: var(--icon-size); object-fit: contain; filter: saturate(0); }
        .card-name { color: var(--text-sub); font-size: 12px; text-align: center; }
        .badge { position: absolute; top: 10px; right: 10px; padding: 4px 8px; background: var(--muted); border-radius: 8px; font-size: 10px; color: var(--text-main); }

        .list { display: grid; gap: 8px; }
        .row { display: flex; justify-content: space-between; align-items: center; padding: 10px 12px; border-radius: var(--radius); background: var(--bg-elevated); border: 1px solid var(--border); }

        .input, select { width: 100%; background: var(--bg-elevated); border: 1px solid var(--border); color: var(--text-main); border-radius: var(--radius); padding: 10px 12px; }
        .split { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }

        .ctx-menu { position: fixed; background: var(--bg-panel); border: 1px solid var(--border); border-radius: 10px; padding: 8px; display: none; flex-direction: column; box-shadow: var(--shadow-strong); z-index: 50; min-width: 200px; }
        .menu-item { padding: 10px; border-radius: 8px; color: var(--text-sub); cursor: pointer; }
        .menu-item:hover { background: var(--bg-hover); color: var(--text-main); }
        .divider { height: 1px; background: var(--border); margin: 6px 0; }

        .toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: var(--text-main); color: var(--bg-body); padding: 10px 16px; border-radius: 999px; opacity: 0; transition: 0.2s; font-size: 12px; }

        .badge-dot { width: 8px; height: 8px; border-radius: 50%; background: #38c172; display: inline-block; margin-right: 6px; }

        @media (max-width: 900px) {
            body { grid-template-columns: 1fr; }
            .sidebar { position: fixed; z-index: 60; height: 100vh; transform: translateX(-100%); transition: 0.3s ease; width: 280px; }
            .sidebar.open { transform: translateX(0); }
            .topbar { position: sticky; top: 0; background: var(--bg-body); z-index: 30; }
            .content { grid-template-columns: 1fr; }
            .grid { grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); }
        }
    </style>
    <style id="custom-css"></style>
</head>
<body data-theme="graphite">
    <aside class="sidebar" id="sidebar">
        <div class="brand">
            <div class="brand-title">Vesper Obsidian Nexus</div>
            <div class="brand-sub">冷淡黑白的多模态工作台</div>
        </div>
        <div class="nav-group" id="navGroup"></div>
        <div class="sidebar-footer">
            <button class="btn" id="btnDev" onclick="toggleDevPanel()">开发者模式</button>
            <button class="btn btn-ghost" onclick="toggleSettings()">偏好与主题</button>
            <button class="btn btn-ghost" onclick="toggleSidebar()">收起/展开</button>
        </div>
    </aside>

    <main class="main">
        <div class="topbar">
            <div class="top-title" id="sectionTitle">资源中心</div>
            <input class="search" id="search" placeholder="搜索图标、资源、笔记..." oninput="handleSearch(event)">
            <div class="chips" id="chipBar"></div>
        </div>
        <div class="content">
            <section class="panel" style="grid-row: span 2;" id="workspacePanel">
                <div class="panel-header">
                    <div>
                        <div class="panel-title">资源工作区</div>
                        <div class="muted">分组可自由拖拽，三击删除（仅开发者）。</div>
                    </div>
                    <div class="chips" id="layoutChips"></div>
                </div>
                <div class="grid" id="cardGrid"></div>
                <button class="btn" id="addIconBtn" style="display:none;" onclick="openAddIcon()">新增图标/链接</button>
            </section>

            <section class="panel" id="resourcePanel">
                <div class="panel-header">
                    <div class="panel-title">功能分区</div>
                    <div class="muted">网盘 / 资源 / 笔记 / 工具箱 / AI / 博客</div>
                </div>
                <div class="list" id="featureList"></div>
            </section>

            <section class="panel" id="accountPanel">
                <div class="panel-header">
                    <div class="panel-title">账户与权限</div>
                    <div class="muted">注册、登录、VIP、封禁与开发者认证</div>
                </div>
                <div class="list" id="authArea"></div>
            </section>

            <section class="panel" id="adminPanel">
                <div class="panel-header">
                    <div class="panel-title">最高管理者控制台</div>
                    <div class="muted">仅最高权限可见，管理识别码 / 优惠码 / 用户</div>
                </div>
                <div class="list" id="adminArea"></div>
            </section>
        </div>
    </main>

    <div class="ctx-menu" id="ctxMenu">
        <div class="menu-item" onclick="copyAsset('png')">复制 PNG 链接</div>
        <div class="menu-item" onclick="copyAsset('svg')">复制 SVG 链接</div>
        <div class="menu-item" onclick="copyAsset('code')">复制 SVG 代码</div>
        <div class="divider"></div>
        <div class="menu-item" onclick="convertToIco()">转存 ICO</div>
        <div class="menu-item" onclick="downloadAsset()">下载文件</div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
        // ======= 配置数据（置顶） =======
        const baseIconData = [
            { category: "学科", items: [
                { name: "Visual Studio Code", png: "https://cdn.jsdelivr.net/gh/devicons/devicon/icons/vscode/vscode-original.svg", tags:["code","ide"] },
                { name: "Python", png: "https://cdn.jsdelivr.net/gh/devicons/devicon/icons/python/python-original.svg", tags:["language"] },
                { name: "Git", png: "https://cdn.jsdelivr.net/gh/devicons/devicon/icons/git/git-original.svg", tags:["version"] }
            ]},
            { category: "设计灵感", items: [
                { name: "Figma", png: "https://cdn.jsdelivr.net/gh/devicons/devicon/icons/figma/figma-original.svg", tags:["design"] },
                { name: "Sketch", png: "https://cdn.jsdelivr.net/gh/devicons/devicon/icons/sketch/sketch-original.svg", tags:["design"] }
            ]},
            { category: "工具箱", items: [
                { name: "TinyPNG", png: "https://static-00.iconduck.com/assets.00/panda-icon-1024x1024-2gkxx9ys.png", tags:["compress"] },
                { name: "Excalidraw", png: "https://raw.githubusercontent.com/excalidraw/excalidraw/master/public/favicon-256.png", tags:["whiteboard"] },
                { name: "Cron", png: "https://cdn.jsdelivr.net/gh/simple-icons/simple-icons/icons/clockify.svg", tags:["time"] }
            ]}
        ];

        const featureBlocks = [
            { title: "云存储", detail: "安全的加密云盘，支持临时直链分享。", status: "可用", id: "cloud", actions: ["上传", "备份", "链接"] },
            { title: "软件资源", detail: "精选高质量应用与更新镜像。", status: "可用", id: "software", actions: ["下载", "校验", "历史版本"] },
            { title: "笔记矩阵", detail: "多端同步，支持 Markdown / Canvas / 思维导图。", status: "可用", id: "notes", actions: ["新建", "分享", "导出"] },
            { title: "博客与帖子", detail: "发布与订阅，沉淀长期洞见。", status: "预览", id: "blog", actions: ["写作", "排版", "投递"] },
            { title: "科普知识库", detail: "可检索的知识卡片集合。", status: "可用", id: "wiki", actions: ["检索", "引用", "导出"] },
            { title: "AI 接口集成", detail: "统一网关聚合多家模型，支持速率与 Token 控制。", status: "可用", id: "ai", actions: ["调用", "监控", "密钥"] }
        ];

        const uiPresets = [
            { key: "graphite", name: "Graphite", desc: "极冷淡暗色" },
            { key: "dusk", name: "Dusk", desc: "柔和浅色" },
            { key: "quartz", name: "Quartz", desc: "深石英" }
        ];

        // ======= 状态管理 =======
        const deviceId = (() => {
            const existing = localStorage.getItem('vesper_device');
            if(existing) return existing;
            const id = 'DEV-' + crypto.randomUUID();
            localStorage.setItem('vesper_device', id);
            return id;
        })();

        const state = {
            currentCategory: null,
            icons: JSON.parse(localStorage.getItem('nexus_icons') || 'null') || baseIconData,
            devCodes: JSON.parse(localStorage.getItem('nexus_dev_codes') || 'null') || [
                { code: 'Vesper', level: 'root', owner: 'Vesper', boundDevice: null, created: new Date().toISOString(), creator: 'system' }
            ],
            coupons: JSON.parse(localStorage.getItem('nexus_coupons') || '[]'),
            users: JSON.parse(localStorage.getItem('nexus_users') || '[]'),
            currentUser: JSON.parse(localStorage.getItem('nexus_current_user') || 'null'),
            devSession: JSON.parse(localStorage.getItem('nexus_dev_session') || 'null'),
            search: ''
        };

        // ======= 工具函数 =======
        const persist = (key, data) => localStorage.setItem(key, JSON.stringify(data));
        const toastEl = document.getElementById('toast');
        function showToast(msg) {
            toastEl.innerText = msg;
            toastEl.style.opacity = 1;
            setTimeout(()=> toastEl.style.opacity = 0, 2200);
        }

        function currentDevCode() {
            if(state.devSession && state.devSession.deviceId === deviceId) return state.devSession;
            return null;
        }

        // ======= 渲染 =======
        function renderNavigation() {
            const nav = document.getElementById('navGroup');
            nav.innerHTML = '';
            state.icons.forEach(cat => {
                const item = document.createElement('div');
                item.className = 'nav-item ' + (state.currentCategory === cat.category ? 'active' : '');
                item.innerHTML = `<div class="nav-label"><span class="badge-dot"></span>${cat.category}</div><span class="pill">${cat.items.length}</span>`;
                item.onclick = () => { state.currentCategory = cat.category; render(); };
                nav.appendChild(item);
            });
        }

        function renderChips() {
            const chipBar = document.getElementById('chipBar');
            chipBar.innerHTML = '';
            ['全部','图标库','网盘','资源','笔记','博客','AI','工具'].forEach(key => {
                const chip = document.createElement('div');
                chip.className = 'chip' + (state.searchSection === key ? ' active':'');
                chip.innerText = key;
                chip.onclick = () => { state.searchSection = state.searchSection === key ? null : key; render(); };
                chipBar.appendChild(chip);
            });
        }

        function renderLayouts() {
            const layout = document.getElementById('layoutChips');
            layout.innerHTML = '';
            [32,48,72,96].forEach(size => {
                const chip = document.createElement('div');
                chip.className = 'chip';
                chip.innerText = `尺寸 ${size}`;
                chip.onclick = () => { document.documentElement.style.setProperty('--icon-size', size+'px'); };
                layout.appendChild(chip);
            });
        }

        function renderGrid() {
            const grid = document.getElementById('cardGrid');
            grid.innerHTML = '';
            const cat = state.icons.find(c => c.category === state.currentCategory) || state.icons[0];
            state.currentCategory = cat.category;
            document.getElementById('sectionTitle').innerText = `${cat.category} · ${cat.items.length}`;
            const keyword = state.search?.toLowerCase() || '';

            cat.items.filter(it => !keyword || it.name.toLowerCase().includes(keyword) || (it.tags||[]).some(t=>t.includes(keyword))).forEach((item, idx) => {
                const card = document.createElement('div');
                card.className = 'card';
                card.draggable = !!currentDevCode();
                card.dataset.index = idx;
                card.dataset.category = cat.category;
                card.innerHTML = `<img src="${item.png}" alt="${item.name}"><div class="card-name">${item.name}</div>`;
                if(item.tags?.length) {
                    const tag = document.createElement('div');
                    tag.className = 'badge';
                    tag.innerText = item.tags.slice(0,2).join(' / ');
                    card.appendChild(tag);
                }
                card.oncontextmenu = (e)=> openMenu(e, item, cat.category, idx);
                card.onclick = ()=> openMenu({clientX:window.innerWidth-200, clientY:80}, item, cat.category, idx);
                card.addEventListener('dragstart', dragStart);
                card.addEventListener('dragover', dragOver);
                card.addEventListener('drop', dropCard);
                card.addEventListener('dragend', dragEnd);
                let tapCount = 0; let timer;
                card.addEventListener('click', ()=> {
                    tapCount++; clearTimeout(timer);
                    timer = setTimeout(()=> tapCount=0, 400);
                    if(tapCount>=3 && currentDevCode()) { deleteIcon(cat.category, idx); tapCount=0; }
                });
                grid.appendChild(card);
            });
        }

        function renderFeatures() {
            const list = document.getElementById('featureList');
            list.innerHTML = '';
            featureBlocks.forEach(b => {
                const row = document.createElement('div');
                row.className = 'row';
                row.innerHTML = `<div><div style="font-weight:600">${b.title}</div><div class="muted">${b.detail}</div></div><div class="pill">${b.status}</div>`;
                row.onclick = ()=> showToast(`${b.title} 已加载`);
                list.appendChild(row);
            });
        }

        function renderAuth() {
            const area = document.getElementById('authArea');
            area.innerHTML = '';
            const user = state.currentUser;
            if(!user) {
                area.appendChild(buildAuthForm());
            } else {
                const row = document.createElement('div');
                row.className = 'row';
                row.innerHTML = `<div><div style="font-weight:600">${user.nickname} (${user.email})</div><div class="muted">等级：${user.role || '用户'} · VIP：${user.vip||'无'}</div></div><div class="chips"></div>`;
                const action = document.createElement('div');
                action.className = 'chips';
                const logout = document.createElement('div'); logout.className='chip'; logout.innerText='退出'; logout.onclick=logoutUser;
                const dev = document.createElement('div'); dev.className='chip'; dev.innerText='绑定开发者'; dev.onclick=()=> openDevVerify();
                const vip = document.createElement('div'); vip.className='chip'; vip.innerText='开通 VIP'; vip.onclick=()=> openVipPurchase();
                action.append(logout, dev, vip);
                row.querySelector('.chips').replaceWith(action);
                area.appendChild(row);
            }
        }

        function renderAdmin() {
            const area = document.getElementById('adminArea');
            area.innerHTML = '';
            const dev = currentDevCode();
            if(!dev || (dev.level !== 'root' && dev.level !== 'elite')) {
                const blocked = document.createElement('div');
                blocked.className = 'row';
                blocked.innerHTML = '<div><div style="font-weight:600">需最高权限</div><div class="muted">绑定最高权限识别码后可管理。</div></div>';
                area.appendChild(blocked);
                return;
            }
            area.appendChild(buildCodeManager());
            area.appendChild(buildCouponManager());
            area.appendChild(buildUserInspector());
        }

        function renderDevButton() {
            const btn = document.getElementById('btnDev');
            const dev = currentDevCode();
            if(dev) {
                btn.innerText = `开发者模式 · ${dev.level.toUpperCase()}`;
                document.getElementById('addIconBtn').style.display = 'block';
            } else {
                btn.innerText = '开发者模式';
                document.getElementById('addIconBtn').style.display = 'none';
            }
        }

        function render() {
            renderNavigation();
            renderChips();
            renderLayouts();
            renderGrid();
            renderFeatures();
            renderAuth();
            renderAdmin();
            renderDevButton();
        }

        // ======= 拖拽与编辑 =======
        let dragPayload = null;
        function dragStart(e) { dragPayload = { category: e.currentTarget.dataset.category, index: Number(e.currentTarget.dataset.index) }; e.currentTarget.classList.add('dragging'); }
        function dragOver(e) { e.preventDefault(); }
        function dragEnd(e) { e.currentTarget.classList.remove('dragging'); dragPayload=null; }
        function dropCard(e) {
            e.preventDefault();
            if(!currentDevCode() || !dragPayload) return;
            const targetCat = e.currentTarget.dataset.category;
            const targetIdx = Number(e.currentTarget.dataset.index);
            const sourceCat = state.icons.find(c=>c.category===dragPayload.category);
            const [item] = sourceCat.items.splice(dragPayload.index,1);
            const destCat = state.icons.find(c=>c.category===targetCat);
            destCat.items.splice(targetIdx,0,item);
            persist('nexus_icons', state.icons);
            render();
        }

        function deleteIcon(category, idx) {
            const cat = state.icons.find(c=>c.category===category);
            cat.items.splice(idx,1);
            persist('nexus_icons', state.icons);
            showToast('已删除');
            render();
        }

        function openAddIcon() {
            const name = prompt('名称'); if(!name) return;
            const link = prompt('PNG/SVG 链接'); if(!link) return;
            const category = prompt('分组（若不存在将自动创建）', state.currentCategory);
            const tags = prompt('标签（逗号分隔，可选）','').split(',').map(t=>t.trim()).filter(Boolean);
            let cat = state.icons.find(c=>c.category===category);
            if(!cat) { cat = { category, items: [] }; state.icons.push(cat); }
            cat.items.push({ name, png: link, tags });
            persist('nexus_icons', state.icons);
            render();
        }

        // ======= 上下文菜单 =======
        let selectedAsset = null;
        function openMenu(e, item, category, idx) {
            e.preventDefault();
            selectedAsset = { item, category, idx };
            const menu = document.getElementById('ctxMenu');
            menu.style.display = 'flex';
            menu.style.left = `${e.clientX}px`;
            menu.style.top = `${e.clientY}px`;
        }
        document.addEventListener('click', (e)=>{ if(!e.target.closest('.ctx-menu')) document.getElementById('ctxMenu').style.display='none'; });

        async function copyAsset(type) {
            if(!selectedAsset) return;
            const url = selectedAsset.item.png;
            try {
                if(type==='png' || type==='svg') await navigator.clipboard.writeText(url);
                if(type==='code') {
                    const text = await fetch(url).then(r=>r.text());
                    await navigator.clipboard.writeText(text);
                }
                showToast('已复制');
            } catch { showToast('复制失败'); }
        }

        async function convertToIco() {
            if(!selectedAsset) return;
            try {
                const img = new Image(); img.crossOrigin='anonymous'; img.src = selectedAsset.item.png;
                await new Promise(res=> img.onload = res);
                const canvas = document.createElement('canvas'); canvas.width=256; canvas.height=256;
                canvas.getContext('2d').drawImage(img,0,0,256,256);
                const blob = await new Promise(res=> canvas.toBlob(res,'image/png'));
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a'); a.href = url; a.download = `${selectedAsset.item.name}.ico`; a.click();
                showToast('已生成 ICO');
            } catch { showToast('转换失败'); }
        }
        async function downloadAsset() { if(selectedAsset) window.open(selectedAsset.item.png,'_blank'); }

        // ======= 主题与设置 =======
        function toggleSettings() {
            const next = prompt('输入主题: graphite / dusk / quartz / 或 CSS 定制');
            if(!next) return;
            if(uiPresets.find(p=>p.key===next)) {
                document.body.setAttribute('data-theme', next);
                localStorage.setItem('nexus_theme', next);
            } else {
                document.getElementById('custom-css').innerHTML = next;
                localStorage.setItem('user_css', next);
            }
        }

        const savedTheme = localStorage.getItem('nexus_theme');
        if(savedTheme) document.body.setAttribute('data-theme', savedTheme);
        const savedCss = localStorage.getItem('user_css');
        if(savedCss) document.getElementById('custom-css').innerHTML = savedCss;

        function toggleSidebar() { document.getElementById('sidebar').classList.toggle('open'); }

        // ======= 搜索 =======
        function handleSearch(e) { state.search = e.target.value; renderGrid(); }

        // ======= 账户体系 =======
        function buildAuthForm() {
            const wrap = document.createElement('div');
            wrap.className = 'row';
            wrap.innerHTML = `<div style="width:100%">
                <div class="split">
                    <input class="input" id="authEmail" placeholder="邮箱">
                    <input class="input" id="authNick" placeholder="昵称">
                </div>
                <div class="split" style="margin-top:8px;">
                    <input class="input" id="authPass" placeholder="密码" type="password">
                    <input class="input" id="authCode" placeholder="验证码">
                </div>
                <div class="split" style="margin-top:8px;">
                    <button class="btn" onclick="sendVerify()">发送验证码</button>
                    <button class="btn" onclick="register()">注册</button>
                </div>
                <div class="split" style="margin-top:8px;">
                    <button class="btn btn-ghost" onclick="login()">登录</button>
                    <button class="btn btn-ghost" onclick="recoverPass()">找回密码</button>
                </div>
            </div>`;
            return wrap;
        }

        function sendVerify() {
            const email = document.getElementById('authEmail').value;
            if(!email) return showToast('请输入邮箱');
            const code = Math.floor(Math.random()*900000+100000).toString();
            localStorage.setItem('verify_'+email, code);
            showToast('验证码已生成: '+code);
        }

        function register() {
            const email = document.getElementById('authEmail').value;
            const nick = document.getElementById('authNick').value || '匿名';
            const pass = document.getElementById('authPass').value;
            const code = document.getElementById('authCode').value;
            if(localStorage.getItem('verify_'+email)!==code) return showToast('验证码错误');
            if(state.users.find(u=>u.email===email)) return showToast('已注册');
            const user = { email, nickname:nick, pass, role:'user', vip:null, status:'active', created:new Date().toISOString() };
            state.users.push(user); persist('nexus_users', state.users);
            state.currentUser = user; persist('nexus_current_user', user);
            showToast('注册成功'); renderAuth(); renderAdmin();
        }

        function login() {
            const email = document.getElementById('authEmail').value;
            const pass = document.getElementById('authPass').value;
            const user = state.users.find(u=>u.email===email && u.pass===pass);
            if(!user) return showToast('账号或密码错误');
            if(user.status==='banned') return showToast('已封禁');
            state.currentUser = user; persist('nexus_current_user', user);
            showToast('已登录'); renderAuth();
        }

        function logoutUser() { state.currentUser=null; persist('nexus_current_user', null); renderAuth(); }
        function recoverPass() { const email = prompt('输入邮箱'); if(!email) return; const user = state.users.find(u=>u.email===email); if(!user) return showToast('未注册'); const newPass = prompt('新密码'); user.pass=newPass; persist('nexus_users', state.users); showToast('已重置'); }

        function openVipPurchase() {
            const plan = prompt('选择：月卡/季卡/年卡');
            const coupon = prompt('如有优惠码请输入，否则留空');
            let discount = 1; let note='';
            const found = state.coupons.find(c=>c.code===coupon && !c.used);
            if(found) { discount = found.rate; found.used=true; persist('nexus_coupons', state.coupons); note = `优惠 ${found.label}`; }
            const prices = { '月卡': 20, '季卡': 50, '年卡': 160 };
            const price = prices[plan] || 0;
            if(!state.currentUser) return showToast('需登录');
            state.currentUser.vip = plan || '永久';
            persist('nexus_current_user', state.currentUser);
            persist('nexus_users', state.users.map(u=> u.email===state.currentUser.email? state.currentUser : u));
            showToast(`已开通 ${plan || '体验'} ${note} 价格：${(price*discount)||0}`);
        }

        // ======= 开发者模式 =======
        function toggleDevPanel() {
            const dev = currentDevCode();
            if(dev) { showToast('已是开发者：'+dev.level); return; }
            openDevVerify();
        }

        function openDevVerify() {
            const code = prompt('输入开发者识别码');
            if(!code) return;
            const entry = state.devCodes.find(c=>c.code===code);
            if(!entry) return showToast('识别码无效');
            if(entry.boundDevice && entry.boundDevice!==deviceId) return showToast('识别码已绑定其他设备');
            entry.boundDevice = deviceId; persist('nexus_dev_codes', state.devCodes);
            state.devSession = { code: entry.code, level: entry.level, deviceId }; persist('nexus_dev_session', state.devSession);
            showToast('开发者模式已开启'); render();
        }

        function buildCodeManager() {
            const panel = document.createElement('div'); panel.className='row';
            panel.innerHTML = '<div><div style="font-weight:600">开发者识别码</div><div class="muted">生成、绑定、回收</div></div>';
            const btn = document.createElement('button'); btn.className='btn'; btn.innerText='生成';
            btn.onclick = () => {
                const custom = prompt('自定义识别码（留空自动生成）');
                const qty = Number(prompt('生成数量', '1')) || 1;
                const level = prompt('等级：root / elite / dev','dev');
                for(let i=0;i<qty;i++) {
                    const code = custom || ('DEV-'+Math.random().toString(36).slice(2,8)).toUpperCase();
                    state.devCodes.push({ code, level, owner:'generated', boundDevice:null, created:new Date().toISOString(), creator: state.devSession.code });
                }
                persist('nexus_dev_codes', state.devCodes); renderAdmin(); showToast('已生成');
            };
            panel.appendChild(btn);
            const list = document.createElement('div'); list.className='list'; list.style.marginTop='10px';
            state.devCodes.slice(-6).reverse().forEach(c=> {
                const row = document.createElement('div'); row.className='row';
                row.innerHTML = `<div><div>${c.code}</div><div class="muted">等级:${c.level} · 绑定:${c.boundDevice||'未绑定'} · 生成者:${c.creator}</div></div>`;
                const action = document.createElement('div'); action.className='chip'; action.innerText='收回'; action.onclick=()=> { state.devCodes = state.devCodes.filter(x=>x.code!==c.code); persist('nexus_dev_codes', state.devCodes); renderAdmin(); };
                row.appendChild(action); list.appendChild(row);
            });
            panel.appendChild(list);
            return panel;
        }

        function buildCouponManager() {
            const panel = document.createElement('div'); panel.className='row';
            panel.innerHTML = '<div><div style="font-weight:600">优惠码</div><div class="muted">折扣 / 免费体验 / 永久解锁</div></div>';
            const btn = document.createElement('button'); btn.className='btn'; btn.innerText='生成优惠码';
            btn.onclick = () => {
                const label = prompt('类型：9折/7折/5折/3折/免费月卡/免费周卡/免费季卡/免费年卡/永久');
                const rateMap = { '9折':0.9,'7折':0.7,'5折':0.5,'3折':0.3,'免费月卡':0,'免费周卡':0,'免费季卡':0,'免费年卡':0,'永久':0 };
                const rate = rateMap[label] ?? 1;
                const code = ('VIP-'+Math.random().toString(36).slice(2,8)).toUpperCase();
                state.coupons.push({ code, label, rate, used:false, created:new Date().toISOString(), creator: state.devSession.code });
                persist('nexus_coupons', state.coupons); renderAdmin(); showToast(code);
            };
            panel.appendChild(btn);
            const list = document.createElement('div'); list.className='list'; list.style.marginTop='10px';
            state.coupons.slice(-5).reverse().forEach(c=> {
                const row = document.createElement('div'); row.className='row';
                row.innerHTML = `<div><div>${c.code}</div><div class="muted">${c.label} · ${c.used?'已用':'未用'} · ${c.creator}</div></div>`;
                const revoke = document.createElement('div'); revoke.className='chip'; revoke.innerText='收回'; revoke.onclick=()=> { state.coupons = state.coupons.filter(x=>x.code!==c.code); persist('nexus_coupons', state.coupons); renderAdmin(); };
                row.appendChild(revoke); list.appendChild(row);
            });
            panel.appendChild(list);
            return panel;
        }

        function buildUserInspector() {
            const panel = document.createElement('div'); panel.className='row';
            panel.innerHTML = '<div><div style="font-weight:600">用户总览</div><div class="muted">封禁 / VIP 指定 / 授予开发者</div></div>';
            const list = document.createElement('div'); list.className='list'; list.style.marginTop='10px';
            state.users.slice(-5).reverse().forEach(u=> {
                const row = document.createElement('div'); row.className='row';
                row.innerHTML = `<div><div>${u.nickname}</div><div class="muted">${u.email} · ${u.vip||'无'} · ${u.status}</div></div>`;
                const actions = document.createElement('div'); actions.className='chips';
                const ban = document.createElement('div'); ban.className='chip'; ban.innerText='封禁'; ban.onclick=()=> { u.status='banned'; persist('nexus_users', state.users); renderAdmin(); };
                const gift = document.createElement('div'); gift.className='chip'; gift.innerText='授予VIP'; gift.onclick=()=> { u.vip='永久'; persist('nexus_users', state.users); renderAdmin(); };
                const dev = document.createElement('div'); dev.className='chip'; dev.innerText='授予开发者'; dev.onclick=()=> { const code = ('DEV-'+Math.random().toString(36).slice(2,8)).toUpperCase(); state.devCodes.push({ code, level:'dev', owner:u.email, boundDevice:null, created:new Date().toISOString(), creator: state.devSession.code }); persist('nexus_dev_codes', state.devCodes); renderAdmin(); };
                actions.append(ban,gift,dev); row.appendChild(actions);
                list.appendChild(row);
            });
            panel.appendChild(list);
            return panel;
        }

        // ======= 初始化 =======
        state.currentCategory = state.icons[0]?.category;
        render();
    </script>
</body>
</html>
