<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Icon Hub Pro</title>
    <style id="app-style">
        :root {
            /* === 基础变量 === */
            --bg-body: #ffffff;
            --bg-sidebar: #f5f5f7;
            --bg-hover: #e5e5ea;
            --border: #d1d1d6;
            --text-main: #1d1d1f;
            --text-sub: #86868b;
            --accent: #000000;
            --radius: 8px;
            --font-stack: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            
            /* 尺寸配置 */
            --sidebar-width: 220px;
            --icon-size: 48px;
            --grid-gap: 20px;
        }

        /* === 纯黑模式 (OLED Pure Black) === */
        [data-theme="dark"] {
            --bg-body: #000000;
            --bg-sidebar: #000000;
            --bg-hover: #1c1c1e;
            --border: #333333;
            --text-main: #ffffff;
            --text-sub: #6e6e73;
            --accent: #ffffff;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        
        body {
            margin: 0;
            font-family: var(--font-stack);
            background: var(--bg-body);
            color: var(--text-main);
            height: 100vh;
            display: flex;
            overflow: hidden;
            font-size: 13px;
        }

        /* SVG 图标通用样式 */
        .icon { width: 16px; height: 16px; stroke: currentColor; stroke-width: 2; fill: none; stroke-linecap: round; stroke-linejoin: round; }
        .icon-sm { width: 14px; height: 14px; }

        /* ================== 侧边栏 (Sidebar) ================== */
        .sidebar {
            width: var(--sidebar-width);
            background: var(--bg-sidebar);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            padding: 20px 0;
            z-index: 20;
            flex-shrink: 0;
        }

        .brand {
            padding: 0 20px 20px;
            font-size: 14px;
            font-weight: 600;
            letter-spacing: -0.3px;
            color: var(--text-main);
            opacity: 0.8;
        }

        .nav-list { flex: 1; overflow-y: auto; padding: 0 10px; }

        .nav-item {
            padding: 8px 12px;
            margin-bottom: 2px;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            color: var(--text-sub);
            transition: color 0.2s, background 0.2s;
        }

        .nav-item:hover { color: var(--text-main); background: var(--bg-hover); }
        .nav-item.active { color: var(--text-main); background: var(--bg-hover); font-weight: 600; }
        .nav-count { opacity: 0.4; font-size: 12px; }

        /* 底部设置按钮 (极简文字) */
        .sidebar-footer {
            padding: 10px 20px;
            border-top: 1px solid var(--border);
        }
        .btn-prefs {
            background: none; border: none; padding: 0;
            color: var(--text-sub); cursor: pointer;
            font-size: 12px; display: flex; align-items: center; gap: 6px;
            opacity: 0.6; transition: opacity 0.2s;
        }
        .btn-prefs:hover { opacity: 1; color: var(--text-main); }

        /* ================== 主内容区 ================== */
        .main {
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        /* 移动端 Header (仅在窄屏显示) */
        .mobile-header {
            display: none;
            padding: 15px 20px;
            border-bottom: 1px solid var(--border);
            justify-content: space-between;
            align-items: center;
        }
        .mobile-title { font-weight: 600; font-size: 14px; }
        .mobile-btn { background: none; border: none; padding: 5px; color: var(--text-sub); cursor: pointer; }

        .content-area {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: var(--grid-gap);
            padding-bottom: 100px;
        }

        /* ================== 卡片样式 (Clean) ================== */
        .card {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 15px 5px;
            border-radius: var(--radius);
            cursor: pointer;
            transition: background 0.2s;
            position: relative;
            border: 1px solid transparent;
        }

        .card:hover { background: var(--bg-hover); }
        /* 纯黑模式下的微边框增强识别度 */
        [data-theme="dark"] .card { border-color: rgba(255,255,255,0.05); }
        [data-theme="dark"] .card:hover { border-color: #333; }

        .card-img {
            width: var(--icon-size);
            height: var(--icon-size);
            object-fit: contain;
            transition: transform 0.2s;
            /* 允许拖拽 */
            -webkit-user-drag: element;
        }

        .card:active .card-img { transform: scale(0.95); }

        .card-name {
            margin-top: 12px;
            font-size: 11px;
            color: var(--text-sub);
            text-align: center;
            width: 100%;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .card:hover .card-name { color: var(--text-main); }


        /* ================== 菜单 (Text Only) ================== */
        .ctx-menu {
            position: fixed;
            background: var(--bg-body);
            border: 1px solid var(--border);
            padding: 4px;
            min-width: 140px;
            border-radius: 6px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            display: none;
            flex-direction: column;
            z-index: 1000;
        }
        [data-theme="dark"] .ctx-menu { box-shadow: 0 0 0 1px #333, 0 10px 30px rgba(0,0,0,0.5); border: none; }

        .menu-item {
            padding: 8px 12px;
            font-size: 12px;
            color: var(--text-main);
            cursor: pointer;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .menu-item:hover { background: var(--bg-hover); }
        .menu-divider { height: 1px; background: var(--border); margin: 3px 0; }
        .menu-shortcut { opacity: 0.3; } /* 图标位 */

        /* 移动端菜单样式 */
        .menu-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 999; display: none;
        }

        /* ================== 设置面板 ================== */
        .settings-panel {
            position: fixed; 
            top: 0; right: 0; bottom: 0; /* 贴右 */
            width: 300px; /* 固定宽 */
            background: var(--bg-body);
            z-index: 2000;
            transform: translateX(100%); /* 横向隐藏 */
            transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            display: flex; flex-direction: column;
            border-left: 1px solid var(--border);
            box-shadow: -5px 0 30px rgba(0,0,0,0.1);
        }
        .settings-panel.open { transform: translateX(0); } /* 横向滑出 */

        .settings-header {
            padding: 15px 20px;
            border-bottom: 1px solid var(--border);
            display: flex; justify-content: space-between; align-items: center;
        }
        .close-btn { background: none; border: none; color: var(--text-main); cursor: pointer; padding: 5px; }

        .settings-content { flex: 1; overflow-y: auto; padding: 20px; width: 100%; }

        .section { margin-bottom: 30px; }
        .section-title { font-size: 11px; text-transform: uppercase; color: var(--text-sub); margin-bottom: 15px; letter-spacing: 0.5px; font-weight: 600; }
        
        /* 选项行 */
        .opt-row { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; font-size: 13px; }
        
        input[type="range"] { width: 140px; height: 4px; background: var(--border); border-radius: 2px; -webkit-appearance: none; }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; width: 16px; height: 16px; background: var(--text-main); border-radius: 50%; cursor: pointer; }

        /* 切换按钮 */
        .toggle-group { display: flex; border: 1px solid var(--border); border-radius: 6px; overflow: hidden; }
        .toggle-btn { flex: 1; background: none; border: none; padding: 8px; color: var(--text-sub); cursor: pointer; font-size: 12px; }
        .toggle-btn.active { background: var(--text-main); color: var(--bg-body); }

        /* 代码框 */
        textarea {
            width: 100%; height: 100px; background: var(--bg-hover); border: 1px solid var(--border);
            color: var(--text-main); padding: 10px; font-family: monospace; font-size: 12px;
            border-radius: 6px; resize: vertical; margin-bottom: 5px;
        }

        /* 提示条 */
        .toast {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            background: var(--text-main); color: var(--bg-body); padding: 8px 16px;
            border-radius: 4px; font-size: 12px; opacity: 0; pointer-events: none; transition: 0.2s;
        }

        /* ================== 响应式 ================== */
        @media (max-width: 768px) {
            .sidebar { display: none; } /* 隐藏侧边栏 */
            .mobile-header { display: flex; } /* 显示手机顶栏 */
            
            /* 手机端横向导航栏 */
            .mobile-nav { 
                display: flex; overflow-x: auto; padding: 10px 15px; 
                border-bottom: 1px solid var(--border); gap: 10px;
            }
            .mobile-nav::-webkit-scrollbar { display: none; }
            .m-nav-pill {
                padding: 6px 12px; font-size: 12px; border-radius: 15px; 
                background: var(--bg-hover); color: var(--text-sub); white-space: nowrap;
            }
            .m-nav-pill.active { background: var(--text-main); color: var(--bg-body); }

            .content-area { padding: 15px; }
            
            /* 手机端设置面板逻辑 */
            .settings-panel { width: 100%; border-left: none; }
            
            /* 手机端菜单变为底部面板 */
            .ctx-menu.mobile-sheet {
                border-radius: 12px 12px 0 0;
                width: 100%; bottom: 0; top: auto; left: 0; right: 0;
                padding: 20px 20px 40px;
                border: none; border-top: 1px solid var(--border);
                transform: translateY(100%); transition: transform 0.2s;
                display: flex !important;
            }
            .ctx-menu.mobile-sheet.show { transform: translateY(0); }
            .menu-item { padding: 15px 0; font-size: 15px; }
        }
    </style>
    <style id="custom-css"></style>
</head>
<body data-theme="dark">

    <div class="sidebar">
        <div class="brand" id="lbl-brand"></div>
        <div class="nav-list" id="sidebarNav"></div>
        <div class="sidebar-footer">
            <button class="btn-prefs" onclick="openSettings()">
                <svg class="icon icon-sm" viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
                <span id="lbl-prefs"></span>
            </button>
        </div>
    </div>

    <div class="main">
        <div class="mobile-header">
            <div class="mobile-title" id="lbl-mobile-title"></div>
            <button class="mobile-btn" onclick="openSettings()">
                <svg class="icon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
            </button>
        </div>
        <div class="mobile-nav" id="mobileNav"></div>

        <div class="content-area">
            <div class="grid" id="grid">
                </div>
        </div>
    </div>

    <div class="menu-overlay" id="menuOverlay" onclick="closeMenu()"></div>
    <div class="ctx-menu" id="ctxMenu">
        <div class="menu-item" onclick="act('link')">
            <span id="lbl-copy-link"></span>
            <svg class="icon-sm menu-shortcut" viewBox="0 0 24 24"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg>
        </div>
        <div class="menu-item" onclick="act('svg_link')">
            <span id="lbl-copy-svg"></span>
            <svg class="icon-sm menu-shortcut" viewBox="0 0 24 24"><polyline points="16 18 22 12 16 6"></polyline><polyline points="8 6 2 12 8 18"></polyline></svg>
        </div>
        <div class="menu-divider"></div>
        <div class="menu-item" onclick="act('img')">
            <span id="lbl-copy-img"></span>
            <svg class="icon-sm menu-shortcut" viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg>
        </div>
        <div class="menu-item" onclick="act('code')">
            <span id="lbl-copy-code"></span>
            <svg class="icon-sm menu-shortcut" viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
        </div>
        <div class="menu-divider"></div>
        <div class="menu-item" onclick="act('ico')">
            <span id="lbl-to-ico"></span>
            <svg class="icon-sm menu-shortcut" viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
        </div>
    </div>

    <div class="settings-panel" id="settingsPanel">
        <div class="settings-header">
            <span style="font-weight:600;" id="lbl-settings-title"></span>
            <button class="close-btn" onclick="closeSettings()">
                <svg class="icon" viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
            </button>
        </div>
        <div class="settings-content">
            <div class="section">
                <div class="section-title" id="lbl-appearance"></div>
                <div class="toggle-group">
                    <button class="toggle-btn" onclick="setTheme('light')" id="lbl-light">Light</button>
                    <button class="toggle-btn active" onclick="setTheme('dark')" id="lbl-dark">Dark</button>
                </div>
            </div>

            <div class="section">
                <div class="section-title" id="lbl-layout"></div>
                <div class="opt-row">
                    <span id="lbl-size">Icon Size</span>
                    <input type="range" min="32" max="100" value="48" oninput="setStyle('--icon-size', this.value+'px')">
                </div>
                <div class="opt-row">
                    <span id="lbl-spacing">Spacing</span>
                    <input type="range" min="10" max="50" value="20" oninput="setStyle('--grid-gap', this.value+'px')">
                </div>
            </div>

            <div class="section">
                <div class="section-title" id="lbl-script"></div>
                <div style="font-size:11px; color:var(--text-sub); margin-bottom:5px;" id="lbl-css">CSS</div>
                <textarea id="inputCss" placeholder="body { ... }" oninput="saveAndApplyCss(this.value)"></textarea>
                
                <div style="font-size:11px; color:var(--text-sub); margin-bottom:5px; margin-top:10px;" id="lbl-js">JS</div>
                <textarea id="inputJs" placeholder="console.log('Loaded');" onchange="saveJs(this.value)"></textarea>
                <div style="font-size:10px; color:var(--text-sub); text-align:right;" id="lbl-save-hint"></div>
            </div>
        </div>
    </div>

    <div class="toast" id="toast">Copied</div>

<script>
// =========================================================================
//                           语言 配置区域 
// =========================================================================
const trans = {
    brand: "素材资源库",
    prefsBtn: "偏好设置",
    mobileTitle: "资源库",

    // 菜单项
    copyLink: "复制PNG链接",
    copySvgLink: "复制 SVG 链接",
    copyImage: "复制图片文件",
    copyCode: "复制 SVG 代码",
    toIco: "转存为 ICO",

    // 设置面板
    settingsTitle: "偏好设置",
    appearance: "外观主题",
    light: "浅色模式",
    dark: "深色模式",
    layout: "布局设置",
    size: "图标大小",
    spacing: "网格间距",
    customScript: "自定义脚本",
    cssLabel: "CSS 样式 (自动保存)",
    jsLabel: "JavaScript (刷新生效)",
    saveHint: "内容已保存",

    // 提示信息 (Toast)
    toastLink: "链接已复制",
    toastSvg: "SVG 链接已复制",
    toastImg: "图片已复制",
    toastCode: "代码已复制",
    toastIco: "ICO 已下载",
    toastFail: "操作失败",
    toastConvert: "正在转换...",
    toastError: "转换出错"
};


// =========================================================================
//                           图标数据 配置区域 
// =========================================================================
const iconData = [
    {
        category: "学科",
        items: [
            { name: "Visual Studio Code", png: "https://cdn.jsdelivr.net/gh/devicons/devicon/icons/vscode/vscode-original.svg" },
            { name: "Python", png: "https://cdn.jsdelivr.net/gh/devicons/devicon/icons/python/python-original.svg" },
            { name: "Git", png: "https://cdn.jsdelivr.net/gh/devicons/devicon/icons/git/git-original.svg" }
        ]
    },
    {
        category: "设计灵感",
        items: [
            { name: "Figma", png: "https://cdn.jsdelivr.net/gh/devicons/devicon/icons/figma/figma-original.svg" },
            { name: "Sketch", png: "https://cdn.jsdelivr.net/gh/devicons/devicon/icons/sketch/sketch-original.svg" }
        ]
    }
];


// =========================================================================
//                            系统逻辑区域
// =========================================================================

    let currentCat = iconData[0].category;
    let selectedItem = null;

    function init() {
        applyTranslations();
        renderNav();
        renderGrid(currentCat);
        loadCustomScripts();
        
        document.addEventListener('click', e => {
            if(!e.target.closest('.ctx-menu') && !e.target.closest('.card')) {
                closeMenu();
            }
        });
    }

    // 应用翻译
    function applyTranslations() {
        // 主界面
        document.getElementById('lbl-brand').innerText = trans.brand;
        document.getElementById('lbl-prefs').innerText = trans.prefsBtn;
        document.getElementById('lbl-mobile-title').innerText = trans.mobileTitle;
        
        // 菜单
        document.getElementById('lbl-copy-link').innerText = trans.copyLink;
        document.getElementById('lbl-copy-svg').innerText = trans.copySvgLink;
        document.getElementById('lbl-copy-img').innerText = trans.copyImage;
        document.getElementById('lbl-copy-code').innerText = trans.copyCode;
        document.getElementById('lbl-to-ico').innerText = trans.toIco;
        
        // 设置
        document.getElementById('lbl-settings-title').innerText = trans.settingsTitle;
        document.getElementById('lbl-appearance').innerText = trans.appearance;
        document.getElementById('lbl-light').innerText = trans.light;
        document.getElementById('lbl-dark').innerText = trans.dark;
        document.getElementById('lbl-layout').innerText = trans.layout;
        document.getElementById('lbl-size').innerText = trans.size;
        document.getElementById('lbl-spacing').innerText = trans.spacing;
        document.getElementById('lbl-script').innerText = trans.customScript;
        document.getElementById('lbl-css').innerText = trans.cssLabel;
        document.getElementById('lbl-js').innerText = trans.jsLabel;
        document.getElementById('lbl-save-hint').innerText = trans.saveHint;
    }

    function renderNav() {
        const deskNav = document.getElementById('sidebarNav');
        deskNav.innerHTML = '';
        const mobNav = document.getElementById('mobileNav');
        mobNav.innerHTML = '';

        iconData.forEach(g => {
            const dEl = document.createElement('div');
            dEl.className = `nav-item ${g.category === currentCat ? 'active' : ''}`;
            dEl.innerHTML = `<span>${g.category}</span><span class="nav-count">${g.items.length}</span>`;
            dEl.onclick = () => switchCat(g.category);
            deskNav.appendChild(dEl);

            const mEl = document.createElement('div');
            mEl.className = `m-nav-pill ${g.category === currentCat ? 'active' : ''}`;
            mEl.innerText = g.category;
            mEl.onclick = () => switchCat(g.category);
            mobNav.appendChild(mEl);
        });
    }

    function switchCat(cat) {
        currentCat = cat;
        renderNav();
        renderGrid(cat);
    }

    function renderGrid(cat) {
        const grid = document.getElementById('grid');
        grid.innerHTML = '';
        const group = iconData.find(g => g.category === cat);
        if(group) {
            group.items.forEach(item => {
                const card = document.createElement('div');
                card.className = 'card';
                card.onclick = (e) => openMenu(e, item);
                
                const img = document.createElement('img');
                img.src = item.png;
                img.className = 'card-img';
                img.draggable = true; // 允许拖拽

                const name = document.createElement('div');
                name.className = 'card-name';
                name.innerText = item.name;

                card.appendChild(img);
                card.appendChild(name);
                grid.appendChild(card);
            });
        }
    }

    // 菜单逻辑
    function openMenu(e, item) {
        e.stopPropagation();
        selectedItem = item;
        const menu = document.getElementById('ctxMenu');
        const overlay = document.getElementById('menuOverlay');
        const isMobile = window.innerWidth <= 768;

        menu.style.display = 'flex';
        
        if (isMobile) {
            overlay.style.display = 'block';
            menu.classList.add('mobile-sheet');
            setTimeout(() => menu.classList.add('show'), 10);
        } else {
            menu.classList.remove('mobile-sheet');
            menu.classList.remove('show');
            overlay.style.display = 'none'; // 桌面端不需要遮罩，靠全局点击关闭
            
            // 智能定位
            let x = e.clientX;
            let y = e.clientY;
            const mw = 150; const mh = 200;
            if (x + mw > window.innerWidth) x -= mw;
            if (y + mh > window.innerHeight) y -= mh;
            
            menu.style.left = x + 'px';
            menu.style.top = y + 'px';
        }
    }

    function closeMenu() {
        const menu = document.getElementById('ctxMenu');
        const overlay = document.getElementById('menuOverlay');
        
        if (menu.classList.contains('mobile-sheet')) {
            menu.classList.remove('show');
            setTimeout(() => {
                menu.style.display = 'none';
                overlay.style.display = 'none';
            }, 200);
        } else {
            menu.style.display = 'none';
        }
    }

    // 动作处理
    async function act(type) {
        closeMenu();
        if(!selectedItem) return;
        const url = selectedItem.png;

        try {
            if(type === 'link') {
                await navigator.clipboard.writeText(url);
                showToast(trans.toastLink);
            } else if (type === 'svg_link') {
                await navigator.clipboard.writeText(url);
                showToast(trans.toastSvg);
            } else if (type === 'img') {
                const blob = await fetch(url).then(r => r.blob());
                await navigator.clipboard.write([new ClipboardItem({'image/png': blob})]);
                showToast(trans.toastImg);
            } else if (type === 'code') {
                const text = await fetch(url).then(r => r.text());
                await navigator.clipboard.writeText(text);
                showToast(trans.toastCode);
            } else if (type === 'ico') {
                convertIco(url, selectedItem.name);
            }
        } catch(e) {
            console.error(e);
            showToast(trans.toastFail);
        }
    }

    async function convertIco(url, name) {
        showToast(trans.toastConvert);
        try {
            const img = new Image();
            img.crossOrigin = "Anonymous";
            img.src = url;
            await new Promise(r => img.onload = r);

            const c = document.createElement('canvas');
            c.width = 256; c.height = 256;
            const ctx = c.getContext('2d');
            ctx.drawImage(img, 0, 0, 256, 256);

            const blob = await new Promise(r => c.toBlob(r, 'image/png'));
            const buf = await blob.arrayBuffer();

            const header = new Uint8Array([0,0,1,0,1,0]);
            const entry = new Uint8Array([0,0,0,0,1,0,32,0,0,0,0,0,22,0,0,0]);
            new DataView(entry.buffer).setUint32(8, buf.byteLength, true);

            const icoUrl = URL.createObjectURL(new Blob([header, entry, buf], {type: 'image/x-icon'}));
            const a = document.createElement('a');
            a.href = icoUrl;
            a.download = name + '.ico';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            showToast(trans.toastIco);
        } catch(e) {
            showToast(trans.toastError);
        }
    }

    // 设置与自定义脚本
    function openSettings() {
        document.getElementById('settingsPanel').classList.add('open');
        document.getElementById('inputCss').value = localStorage.getItem('user_css') || '';
        document.getElementById('inputJs').value = localStorage.getItem('user_js') || '';
    }
    
    function closeSettings() {
        document.getElementById('settingsPanel').classList.remove('open');
    }

    function setTheme(theme) {
        document.body.setAttribute('data-theme', theme);
        const btns = document.querySelectorAll('.toggle-btn');
        btns.forEach(b => b.classList.remove('active'));
        event.target.classList.add('active');
    }

    function setStyle(key, val) {
        document.documentElement.style.setProperty(key, val);
    }

    function saveAndApplyCss(css) {
        localStorage.setItem('user_css', css);
        document.getElementById('custom-css').innerHTML = css;
    }

    function saveJs(js) {
        localStorage.setItem('user_js', js);
    }

    function loadCustomScripts() {
        const css = localStorage.getItem('user_css');
        if(css) document.getElementById('custom-css').innerHTML = css;
        const js = localStorage.getItem('user_js');
        if(js) {
            try {
                const script = document.createElement('script');
                script.textContent = js;
                document.body.appendChild(script);
            } catch(e) { console.error("User JS Error", e); }
        }
    }

    function showToast(msg) {
        const t = document.getElementById('toast');
        t.innerText = msg;
        t.style.opacity = 1;
        setTimeout(() => t.style.opacity = 0, 2000);
    }

    init();
</script>
</body>
</html>
